--master computer
--this program oversees the storage and retrieval of items in the storage system.

--initial configuration defaults
local config = {
	-- base master configuration file
	baseCode = "",
	databasePath = "/basedata",
}

if not os.loadAPI("base") then error("Could not load base API!") end
if not os.loadAPI("configuration") then error("Could not load configuration API!") end
if fs.exists("base.conf") then
	config = configuration.load("base.conf")
else
	--initial setup
	print("Initial Setup for Master Base Controller")
	while not os.getComputerLabel() do
		print("Please provide a label for this computer.")
		write("> ")
		local label = read()
		if #label >= 1 then
			os.setComputerLabel(label)
			break
		else
			print("A label is required!")
		end
	end
	while true do
		print("What is the name code for this base?")
		print("Base name codes are used to group and differentiate sites.")
		write("> ")
		local baseCode = read()
		if baseCode and #baseCode > 0 then
			config.baseCode = baseCode
			break
		else
			print("A base name code is required!")
		end
	end
	configuration.save("base.conf", config)
end

peripheral.find("modem", function(name) rednet.open(name) end)

if os.getComputerLabel() then
	rednet.host("lyq-base", os.getComputerLabel())
else
	print("You must label this computer first.")
	return
end

local stations = {}
local stationInfo = {} --keyed by computer ID.

local clientProtocol = {
	protocol = "lyq-base",
	name = "Station",
	online = "station_online",
	offline = "station_offline",
	list = stations,
}

base.initialize(config.baseCode, nil, clientProtocol)

while true do
	local event = {base.handleEvents(os.pullEventRaw())}
	if event[1] == "rednet_message" then
		if event[4] == "lyq-base" and event[3].baseCode == config.baseCode then
			local message = event[3]
			if message.type == "station_info" then
				if not stationInfo[event[2]] then
					stationInfo[event[2]] = {
						locations = message.info,
						capabilities = {},
						type = message.stationType,
					}
				else
					stationInfo[event[2]].locations = message.info
					stationInfo[event[2]].capabilities = {}
					stationInfo[event[2]].type = message.stationType
				end
				local info = stationInfo[event[2]]
				for i, loc in ipairs (info.locations) do
					for match in string.gmatch(loc.capabilities, "(%S+)") do
						if not info.capabilities[match] then
							info.capabilities[match] = {loc.location}
						else
							table.insert(info.capabilities[match], loc.location)
						end
					end
				end
				io.write("Station "..tostring(event[2]).." has capabilities: ")
				for label in pairs(info.capabilities) do
					io.write(label.." ")
				end
				io.write("\n")
			end
		end
	elseif event[1] == "terminate" then
		io.write("Stopping\n")
		return
	end
end
